# NullAI 完全デプロイ手順書

## 📋 実装済み機能の概要

✅ **Google OAuth2認証** - Googleアカウントでログイン  
✅ **ORCID専門家認証** - 自動的にexpertステータス付与  
✅ **ゲストアクセス** - ログイン不要でDBを自由に操作  
✅ **マルチテナントワークスペース** - ユーザーごとに独立したDB環境  
✅ **権限管理システム** - 細かい権限制御  
✅ **完全なエラーハンドリング** - すべてのエラーケースに対応  

---

## 手順1: GitHubリポジトリを作成

### 1-1. GitHubで新規リポジトリを作成

1. **GitHub**にアクセス: https://github.com/new
2. **リポジトリ名**を入力: 例 `nullai-app` または `知識管理システム`
3. **Public**（公開）または **Private**（非公開）を選択
4. **「Create repository」**（リポジトリを作成）をクリック

### 1-2. リモートリポジトリを設定

GitHubでリポジトリを作成したら、以下のコマンドを実行:

```bash
# リモートリポジトリを追加（YOUR_USERNAMEを自分のGitHubユーザー名に変更）
git remote add origin https://github.com/YOUR_USERNAME/nullai-app.git

# 現在のブランチ名を確認
git branch

# mainブランチにリネーム（必要な場合）
git branch -M main

# GitHubにプッシュ
git push -u origin main
```

**実行例:**
```bash
git remote add origin https://github.com/taro-yamada/nullai-app.git
git branch -M main
git push -u origin main
```

プッシュが成功すると、GitHubのリポジトリページでコードが確認できます。

---

## 手順2: Renderでバックエンドをデプロイ

### 2-1. Renderアカウントを作成

1. **Render**にアクセス: https://render.com
2. 「**Get Started**」をクリック
3. GitHubアカウントで連携してサインアップ

### 2-2. 新しいWeb Serviceを作成

1. Renderダッシュボードで「**New +**」ボタンをクリック
2. 「**Web Service**」を選択
3. 「**Connect GitHub**」をクリック（初回のみ）
4. 手順1で作成したリポジトリ（`nullai-app`）を選択
5. 「**Connect**」をクリック

### 2-3. サービス設定を入力

以下の設定を入力します:

| 設定項目 | 入力値 |
|---------|--------|
| **Name** (名前) | `nullai-backend` または `知識管理バックエンド` |
| **Region** (地域) | `Oregon (US West)` |
| **Branch** (ブランチ) | `main` |
| **Root Directory** | 空欄のまま（プロジェクトルート） |
| **Runtime** (実行環境) | `Python 3` |
| **Build Command** (ビルドコマンド) | `pip install -r requirements.production.txt` |
| **Start Command** (起動コマンド) | `uvicorn backend.app.main:app --host 0.0.0.0 --port $PORT` |
| **Instance Type** (インスタンスタイプ) | **Free** (無料) |

### 2-4. 環境変数を設定

「**Environment**」タブまたはセクションで、「**Add Environment Variable**」をクリックして以下を追加:

#### 必須の環境変数:

```
APP_ENV=production
DEMO_MODE=true
ENABLE_INFERENCE=false
CORS_ORIGINS=*
SECRET_KEY=ここにランダムな文字列
```

#### SECRET_KEYの生成方法:

ターミナルで以下のコマンドを実行:
```bash
python -c "import secrets; print(secrets.token_urlsafe(32))"
```

出力された文字列（例: `xK7sP9mN2vL4wR8tY6qH3jF5gB1nM0cA8dE2wQ9sL7pK3mN6vX4`）をコピーして、`SECRET_KEY`の値として設定します。

#### オプションの環境変数（後で追加可能）:

```
# Google OAuth（設定済みの場合）
GOOGLE_CLIENT_ID=your-google-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-google-client-secret
GOOGLE_REDIRECT_URI=https://your-app.onrender.com/api/oauth/google/callback

# ORCID認証（設定済みの場合）
ORCID_CLIENT_ID=APP-XXXXXXXXXXXX
ORCID_CLIENT_SECRET=your-orcid-secret
ORCID_REDIRECT_URI=https://your-app.onrender.com/api/oauth/orcid/callback
```

### 2-5. デプロイを実行

1. すべての設定を確認
2. 「**Create Web Service**」（ウェブサービスを作成）をクリック
3. デプロイが自動的に開始されます

**デプロイの進行状況:**
- 「Logs」タブでリアルタイムにログを確認できます
- ビルドには3〜5分かかります
- 成功すると「Live」ステータスになります

### 2-6. バックエンドURLを確認

デプロイが完了すると、画面上部にURLが表示されます:

```
https://nullai-backend.onrender.com
```

または

```
https://知識管理バックエンド.onrender.com
```

**このURLをメモしてください！** 次のステップで使用します。

### 2-7. 動作確認

ブラウザで以下のURLにアクセスして確認:

```
https://nullai-backend.onrender.com/health
```

以下のレスポンスが返ってくれば成功:
```json
{"status":"ok","service":"ilm-athens-api"}
```

APIドキュメント:
```
https://nullai-backend.onrender.com/docs
```

---

## 手順3: Vercelでフロントエンドをデプロイ

### 3-1. Vercelアカウントを作成

1. **Vercel**にアクセス: https://vercel.com
2. 「**Sign Up**」をクリック
3. GitHubアカウントで連携してサインアップ

### 3-2. 新しいプロジェクトを作成

1. Vercelダッシュボードで「**Add New...**」→ 「**Project**」をクリック
2. 「**Import Git Repository**」セクションで、手順1で作成したリポジトリ（`nullai-app`）を探す
3. リポジトリ名の右側にある「**Import**」ボタンをクリック

### 3-3. プロジェクト設定を入力

以下の設定を入力します:

| 設定項目 | 入力値 |
|---------|--------|
| **Project Name** (プロジェクト名) | `nullai-frontend` または `知識管理フロントエンド` |
| **Framework Preset** (フレームワーク) | `Vite` を選択 |
| **Root Directory** (ルートディレクトリ) | `frontend` と入力 |
| **Build Command** (ビルドコマンド) | `npm run build` (自動入力) |
| **Output Directory** (出力ディレクトリ) | `dist` (自動入力) |

### 3-4. 環境変数を設定

「**Environment Variables**」セクションを展開して、以下を追加:

```
Name: VITE_API_URL
Value: https://nullai-backend.onrender.com
```

**重要:** `Value`には、手順2-6でメモしたRenderのバックエンドURLを入力してください。

### 3-5. デプロイを実行

1. すべての設定を確認
2. 「**Deploy**」（デプロイ）をクリック
3. ビルドとデプロイが自動的に開始されます

**デプロイの進行状況:**
- ビルドログがリアルタイムに表示されます
- ビルドには2〜3分かかります
- 成功すると「Congratulations!」画面が表示されます

### 3-6. フロントエンドURLを確認

デプロイが完了すると、URLが表示されます:

```
https://nullai-frontend.vercel.app
```

または

```
https://nullai-frontend-xxxxx.vercel.app
```

**これがあなたのWebアプリケーションのURLです！**

### 3-7. 動作確認

ブラウザで表示されたURLにアクセスして、アプリケーションが正しく動作することを確認します。

---

## ✅ デプロイ完了！

おめでとうございます！あなたのNullAIアプリケーションがインターネット上で公開されました。

### 📱 アクセス先

- **フロントエンド（Webアプリ）**: https://nullai-frontend.vercel.app
- **バックエンド（API）**: https://nullai-backend.onrender.com
- **APIドキュメント**: https://nullai-backend.onrender.com/docs

### 🎯 利用可能な機能

現在のデモ版で利用できる機能:

✅ **ゲストアクセス** - ログインなしで利用可能  
✅ **データベース操作** - 知識タイルの閲覧・作成・編集  
✅ **ドメイン管理** - 55のドメイン（医療、法律、プログラミングなど）  
✅ **ワークスペース** - 独立したDB環境  

⚠️ **AI推論機能は無効** - デモ版では推論APIは動作しません（無料枠の制限のため）

---

## 🔧 次のステップ（オプション）

### A. カスタムドメインを設定

#### Vercelでカスタムドメインを設定:

1. Vercelプロジェクトページ → **Settings** → **Domains**
2. 自分のドメイン名を入力（例: `knowledge.mydomain.com`）
3. DNSレコードを設定（Vercelが指示を表示）

#### Renderでカスタムドメインを設定:

1. Renderサービスページ → **Settings** → **Custom Domains**
2. 自分のドメイン名を入力（例: `api.mydomain.com`）
3. CNAMEレコードを設定

### B. Google OAuth2を有効化

詳細は「OAuth認証設定ガイド.md」を参照

### C. ORCID専門家認証を有効化

詳細は「OAuth認証設定ガイド.md」を参照

### D. 推論機能を有効化（有料プラン必要）

推論機能を有効にするには:
- Renderで有料プラン（$7/月〜）に変更
- 環境変数を更新: `ENABLE_INFERENCE=true`
- より強力なインスタンスタイプを選択

---

## 🚨 トラブルシューティング

### 問題1: Renderのビルドが失敗する

**症状:** "Build failed" エラー

**確認事項:**
1. `requirements.production.txt` ファイルが存在するか
2. Build Command が正しいか: `pip install -r requirements.production.txt`
3. Pythonバージョンが対応しているか

**解決策:**
- Renderの「Logs」タブでエラーメッセージを確認
- リポジトリに正しいファイルがプッシュされているか確認

### 問題2: Vercelのビルドが失敗する

**症状:** "Build Error" または "Command not found"

**確認事項:**
1. Root Directory が `frontend` になっているか
2. `frontend/package.json` が存在するか
3. Build Command が `npm run build` になっているか

**解決策:**
- Vercelプロジェクト設定を見直す
- Settings → General → Build & Development Settings

### 問題3: APIに接続できない（CORS エラー）

**症状:** ブラウザのコンソールに "CORS policy" エラー

**確認事項:**
1. Renderの環境変数に `CORS_ORIGINS=*` が設定されているか
2. Vercelの環境変数 `VITE_API_URL` が正しいRender URLになっているか

**解決策:**
1. Renderで環境変数を確認・修正
2. Vercelで環境変数を確認・修正後、再デプロイ

### 問題4: Renderのサービスがスリープする

**症状:** 初回アクセス時に30秒〜1分かかる

**原因:** 無料プランは15分間アクセスがないとスリープします

**解決策:**
- これは正常な動作です
- 起動後は高速に動作します
- スリープを回避するには有料プラン（$7/月〜）に変更

### 問題5: ページが真っ白になる

**症状:** フロントエンドにアクセスしてもページが表示されない

**確認事項:**
1. ブラウザのコンソールでエラーを確認
2. Vercelの環境変数 `VITE_API_URL` が設定されているか

**解決策:**
- Vercel → Project → Settings → Environment Variables を確認
- 変更した場合は、Deployments → 最新のデプロイ → Redeploy

---

## 💡 便利なコマンド

### Renderのログをリアルタイムで確認

Renderダッシュボード → サービス → Logs タブ

### Vercelでデプロイをロールバック

Vercel → Project → Deployments → 過去のデプロイを選択 → Promote to Production

### 環境変数を更新した後の再デプロイ

**Render:**
- 自動的に再デプロイされます

**Vercel:**
1. Deployments → 最新 → Redeploy
2. または新しいコミットをプッシュ

---

## 📚 関連ドキュメント

- **OAuth認証設定ガイド.md** - Google/ORCID認証の詳細設定
- **無料デプロイガイド.md** - その他のデプロイオプション
- **環境変数設定例.env** - すべての環境変数の説明

---

## ✉️ サポート

問題が解決しない場合:
1. GitHubリポジトリのIssuesで質問
2. APIドキュメント（/docs）を確認
3. ログファイルを確認してエラーメッセージを特定

成功をお祈りします！🎉
